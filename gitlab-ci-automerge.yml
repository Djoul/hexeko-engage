# Pipeline de promotion progressive des branches
# Workflow: feature â†’ dev (deploy) â†’ staging (deploy) â†’ main (tests) â†’ prod (deploy)
#
# DÃ‰CLENCHEMENT: 100% MANUEL UNIQUEMENT
#   - Via PhpStorm Run Configuration
#   - Via GitLab Web UI (Run Pipeline)
#   - Via curl (depuis votre machine)
#
# Configuration requise dans GitLab CI/CD Variables:
# - CI_AUTOMATION_TOKEN: Personal Access Token avec scopes api, write_repository
#
# DÃ©clenchement manuel depuis votre machine:
# export AUTOMERGE_TRIGGER_TOKEN="votre-token"
# export CI_PROJECT_ID="67270480"
# curl -X POST \
#   -F token=$AUTOMERGE_TRIGGER_TOKEN \
#   -F ref=$(git branch --show-current) \
#   -F "variables[START_PROMOTION]=true" \
#   https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/trigger/pipeline

stages:
  - promote

# Job de promotion progressive (MANUEL UNIQUEMENT)
promote-to-prod:
  stage: promote
  image: alpine:3.19
  rules:
    # UNIQUEMENT dÃ©clenchement manuel via trigger avec START_PROMOTION=true
    - if: '$CI_PIPELINE_SOURCE == "trigger" && $START_PROMOTION == "true"'
      when: always
    # UNIQUEMENT dÃ©clenchement manuel via Web UI avec START_PROMOTION=true
    - if: '$CI_PIPELINE_SOURCE == "web" && $START_PROMOTION == "true"'
      when: always
  variables:
    GIT_STRATEGY: clone
  before_script:
    - |
      echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      echo "â•‘   ğŸš€ PROMOTION PROGRESSIVE VERS PRODUCTION   â•‘"
      echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo ""

    - |
      echo "ğŸ”§ Installation des dÃ©pendances..."
      apk add --no-cache curl jq bash git

    - |
      echo ""
      echo "ğŸ“‹ Configuration:"
      echo "  - Branche: $CI_COMMIT_BRANCH"
      echo "  - Pipeline source: $CI_PIPELINE_SOURCE"
      echo "  - Projet: $CI_PROJECT_PATH"
      echo "  - Pipeline URL: $CI_PIPELINE_URL"
      echo ""

    - |
      echo "ğŸ” VÃ©rification des variables requises..."
      if [ -z "$CI_AUTOMATION_TOKEN" ]; then
        echo "âŒ ERREUR: Variable CI_AUTOMATION_TOKEN non dÃ©finie"
        echo ""
        echo "Configuration requise:"
        echo "1. Aller dans Settings > Access Tokens"
        echo "2. CrÃ©er un token avec:"
        echo "   - Nom: ci-automation"
        echo "   - RÃ´le: Maintainer"
        echo "   - Scopes: api, write_repository"
        echo "3. Copier le token"
        echo "4. Ajouter dans Settings > CI/CD > Variables:"
        echo "   - ClÃ©: CI_AUTOMATION_TOKEN"
        echo "   - Valeur: [votre token]"
        echo "   - Protected: âœ…"
        echo "   - Masked: âœ…"
        exit 1
      fi

      if [ -z "$CI_PROJECT_ID" ]; then
        echo "âŒ ERREUR: Variable CI_PROJECT_ID non dÃ©finie"
        exit 1
      fi

      echo "âœ… Toutes les variables sont dÃ©finies"
      echo ""

    - chmod +x .gitlab/promote-to-prod.sh

  script:
    - |
      echo "ğŸš€ Lancement de la promotion progressive..."
      echo ""
      ./.gitlab/promote-to-prod.sh

  after_script:
    - |
      echo ""
      if [ "$CI_JOB_STATUS" = "success" ]; then
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘        âœ… PROMOTION TERMINÃ‰E AVEC SUCCÃˆS      â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      else
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘              âŒ PROMOTION Ã‰CHOUÃ‰E             â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "VÃ©rifier les logs ci-dessus pour les dÃ©tails"
      fi

  allow_failure: false

  # Pas de retry pour Ã©viter les MR dupliquÃ©s
  timeout: 2h  # 2 heures max pour toute la chaÃ®ne de promotion
